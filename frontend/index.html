<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Company Memo Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <!-- Company Logo -->
  <header>
    <img src="logo.png" alt="Company Logo" id="companyLogo" />
  </header>

  <h1>AMML Memo Dashboard</h1>

  <section>
    <h2>üìä Overall Memo Statistics</h2>
    <p>Total Memos: <span id="total">0</span></p>
    <p>Pending: <span id="pending">0</span></p>
    <p>Approved: <span id="approved">0</span></p>
  </section>

  <section>
    <h2>üìç Memo Statistics by Market</h2>
    <div id="marketStats"></div>
  </section>

  <section>
    <h2>‚ûï Add Memo</h2>
    <form id="memoForm">
      <label>Title:<br /><input type="text" id="title" required /></label><br /><br />
      <label>Description:<br /><textarea id="description" required></textarea></label><br /><br />
      <label>Date:<br /><input type="date" id="date" required /></label><br /><br />
      <label>Time:<br /><input type="time" id="time" required /></label><br /><br />
      <label>Status:<br />
        <select id="status">
          <option value="Pending">Pending</option>
          <option value="Approved">Approved</option>
        </select>
      </label><br /><br />
      <label>Market:<br />
        <select id="market" required>
          <option value="">-- Select Market --</option>
          <option>Apo ZoneA</option>
          <option>Area1 shopping complex</option>
          <option>Area 2 shopping complex</option>
          <option>Area 10 market</option>
          <option>Area 3 market</option>
          <option>Dei Dei Markets</option>
          <option>Garki International Market</option>
          <option>Garki Model Market</option>
          <option>Gudu Market</option>
          <option>Head Office</option>
          <option>Kado Fish Market</option>
          <option>Kaura Market</option>
          <option>Maitama Farmers Market</option>
          <option>Wuse Market</option>
          <option>Zone 3 neighnourhood center</option>
        </select>
      </label><br /><br />
      <button type="submit">Add Memo</button>
    </form>
  </section>

  <section>
    <h2>üìÅ All Memos</h2>
    <div id="memosContainer"></div>
  </section>

  <script>
    const form = document.getElementById('memoForm');
    const memosContainer = document.getElementById('memosContainer');
    const marketStatsDiv = document.getElementById('marketStats');

    // List of markets (for stats display and form select)
    const markets = [
      "Apo ZoneA",
      "Area1 shopping complex",
      "Area 2 shopping complex",
      "Area 10 market",
      "Area 3 market",
      "Dei Dei Markets",
      "Garki International Market",
      "Garki Model Market",
      "Gudu Market",
      "Head Office",
      "Kado Fish Market",
      "Kaura Market",
      "Maitama Farmers Market",
      "Wuse Market",
      "Zone 3 neighnourhood center"
    ];

    async function loadMemos() {
      const response = await fetch('/api/memos');
      const memos = await response.json();

      // Overall stats
      document.getElementById('total').textContent = memos.length;
      document.getElementById('pending').textContent = memos.filter(m => m.status === 'Pending').length;
      document.getElementById('approved').textContent = memos.filter(m => m.status === 'Approved').length;

      // Market stats
      let statsHtml = '<table><thead><tr><th>Market</th><th>Total</th><th>Approved</th><th>Pending</th></tr></thead><tbody>';

      markets.forEach(market => {
        const marketMemos = memos.filter(m => m.market === market);
        const total = marketMemos.length;
        const approved = marketMemos.filter(m => m.status === 'Approved').length;
        const pending = marketMemos.filter(m => m.status === 'Pending').length;

        statsHtml += `
          <tr>
            <td>${market}</td>
            <td>${total}</td>
            <td>${approved}</td>
            <td>${pending}</td>
          </tr>
        `;
      });

      statsHtml += '</tbody></table>';
      marketStatsDiv.innerHTML = statsHtml;

      // Display all memos
      memosContainer.innerHTML = '';

      memos.forEach((memo, index) => {
        const div = document.createElement('div');
        div.className = 'memo';

        div.innerHTML = `
          <strong>${memo.title}</strong> <em>(${memo.status})</em><br>
          <small>${memo.date} ${memo.time} | <strong>Market:</strong> ${memo.market}</small>
          <p>${memo.description}</p>
          <button class="editBtn" data-index="${index}">Edit</button>
          <button class="deleteBtn" data-index="${index}">Delete</button>
          <div class="editFormContainer" style="display:none; margin-top:10px;">
            <form class="editForm" data-index="${index}">
              <label>Title:<br /><input type="text" name="title" value="${memo.title}" required /></label><br /><br />
              <label>Description:<br /><textarea name="description" required>${memo.description}</textarea></label><br /><br />
              <label>Date:<br /><input type="date" name="date" value="${memo.date}" required /></label><br /><br />
              <label>Time:<br /><input type="time" name="time" value="${memo.time}" required /></label><br /><br />
              <label>Status:<br />
                <select name="status" required>
                  <option value="Pending" ${memo.status === 'Pending' ? 'selected' : ''}>Pending</option>
                  <option value="Approved" ${memo.status === 'Approved' ? 'selected' : ''}>Approved</option>
                </select>
              </label><br /><br />
              <label>Market:<br />
                <select name="market" required>
                  ${markets.map(m => `<option value="${m}" ${memo.market === m ? 'selected' : ''}>${m}</option>`).join('')}
                </select>
              </label><br /><br />
              <button type="submit">Save</button>
              <button type="button" class="cancelEditBtn">Cancel</button>
            </form>
          </div>
        `;

        memosContainer.appendChild(div);
      });

      // Delete buttons
      document.querySelectorAll('.deleteBtn').forEach(button => {
        button.addEventListener('click', async e => {
          const index = e.target.getAttribute('data-index');
          if (confirm('Are you sure you want to delete this memo?')) {
            await fetch(`/api/memos/${index}`, { method: 'DELETE' });
            loadMemos();
          }
        });
      });

      // Edit buttons
      document.querySelectorAll('.editBtn').forEach(button => {
        button.addEventListener('click', e => {
          const parentDiv = e.target.parentElement;
          parentDiv.querySelector('.editFormContainer').style.display = 'block';
        });
      });

      // Cancel edit buttons
      document.querySelectorAll('.cancelEditBtn').forEach(button => {
        button.addEventListener('click', e => {
          const formContainer = e.target.closest('.editFormContainer');
          formContainer.style.display = 'none';
        });
      });

      // Submit edit forms
      document.querySelectorAll('.editForm').forEach(form => {
        form.addEventListener('submit', async e => {
          e.preventDefault();
          const index = e.target.getAttribute('data-index');
          const formData = new FormData(e.target);
          const updatedMemo = {
            title: formData.get('title').trim(),
            description: formData.get('description').trim(),
            date: formData.get('date'),
            time: formData.get('time'),
            status: formData.get('status'),
            market: formData.get('market')
          };

          if (!updatedMemo.title || !updatedMemo.description || !updatedMemo.date || !updatedMemo.time || !updatedMemo.status || !updatedMemo.market) {
            alert('Please fill all fields');
            return;
          }

          await fetch(`/api/memos/${index}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updatedMemo)
          });

          loadMemos();
        });
      });
    }

    form.addEventListener('submit', async e => {
      e.preventDefault();
      const newMemo = {
        title: document.getElementById('title').value.trim(),
        description: document.getElementById('description').value.trim(),
        date: document.getElementById('date').value,
        time: document.getElementById('time').value,
        status: document.getElementById('status').value,
        market: document.getElementById('market').value
      };

      if (!newMemo.title || !newMemo.description || !newMemo.date || !newMemo.time || !newMemo.market) {
        alert("Please fill all fields including market.");
        return;
      }

      await fetch('/api/memos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(newMemo)
      });

      form.reset();
      loadMemos();
    });

    loadMemos();
  </script>

</body>
</html>
